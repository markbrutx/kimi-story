---
// Novel Reader — True Minimal
// Pure black, white text, smooth motion, zero bullshit
---

<div class="reader" id="reader">
  <!-- Header -->
  <header class="header" id="header">
    <button class="header-btn" id="menuBtn" aria-label="Menu">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="4" y1="8" x2="20" y2="8"/>
        <line x1="4" y1="16" x2="20" y2="16"/>
      </svg>
    </button>
    <span class="header-title" id="headerTitle">Chapter 1</span>

  </header>

  <!-- Sidebar -->
  <div class="overlay" id="overlay"></div>
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h2>Chapters</h2>
      <button class="close-btn" id="closeBtn">×</button>
    </div>
    <nav class="chapter-list" id="chapterList"></nav>
  </aside>

  <!-- Content -->
  <main class="content" id="content">
    <div class="page">
      <div class="loading" id="loading">
        <div class="loading-line"></div>
      </div>
      
      <article class="chapter" id="chapter" style="display: none;">
        <header class="chapter-header">
          <span class="chapter-num" id="chapterNum">01</span>
          <h1 class="chapter-title" id="chapterTitle"></h1>
        </header>
        <div class="chapter-text" id="chapterText"></div>
      </article>
    </div>
  </main>

  <!-- Navigation -->
  <nav class="nav" id="nav">
    <button class="nav-btn" id="prevBtn" disabled>
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 12H5M12 19l-7-7 7-7"/>
      </svg>
      <span>Prev</span>
    </button>
    <div class="nav-dots" id="navDots"></div>
    <button class="nav-btn" id="nextBtn">
      <span>Next</span>
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M5 12h14M12 5l7 7-7 7"/>
      </svg>
    </button>
  </nav>
</div>

<script>
const BASE = '/kimi-story';
const path = (p) => `${BASE}${p}`;

let current = 1;
let total = 10;
let chapters = [];
let loading = false;

const $ = (id) => document.getElementById(id);

const ui = {
  menuBtn: $('menuBtn'),
  closeBtn: $('closeBtn'),
  overlay: $('overlay'),
  sidebar: $('sidebar'),
  chapterList: $('chapterList'),
  headerTitle: $('headerTitle'),
  loading: $('loading'),
  chapter: $('chapter'),
  chapterNum: $('chapterNum'),
  chapterTitle: $('chapterTitle'),
  chapterText: $('chapterText'),
  prevBtn: $('prevBtn'),
  nextBtn: $('nextBtn'),
  navDots: $('navDots'),
  content: $('content'),
};

async function init() {
  try {
    const res = await fetch(path('/chapters/index.json'));
    const data = await res.json();
    chapters = data.chapters;
    total = data.total_chapters;
    renderList();
    renderDots();
  } catch (e) {
    console.error(e);
  }
  
  const params = new URLSearchParams(location.search);
  const ch = parseInt(params.get('chapter'));
  if (ch >= 1 && ch <= total) current = ch;
  
  load(current);
}

function renderList() {
  ui.chapterList.innerHTML = chapters.map(ch => `
    <button class="list-item ${ch.id === current ? 'active' : ''}" data-id="${ch.id}">
      <span class="item-num">${String(ch.number).padStart(2, '0')}</span>
      <span class="item-title">${ch.title}</span>
    </button>
  `).join('');
  
  document.querySelectorAll('.list-item').forEach(btn => {
    btn.addEventListener('click', () => {
      load(parseInt(btn.dataset.id));
      closeSidebar();
    });
  });
}

function renderDots() {
  ui.navDots.innerHTML = chapters.map((_, i) => 
    `<span class="dot ${i + 1 === current ? 'active' : ''}" data-i="${i + 1}"></span>`
  ).join('');
  
  document.querySelectorAll('.dot').forEach(dot => {
    dot.addEventListener('click', () => load(parseInt(dot.dataset.i)));
  });
}

async function load(id) {
  if (loading || id < 1 || id > total) return;
  
  loading = true;
  current = id;
  
  history.replaceState({}, '', `?chapter=${id}`);
  
  ui.loading.style.display = 'flex';
  ui.chapter.style.display = 'none';
  
  try {
    const res = await fetch(path(`/chapters/chapter_${String(id).padStart(3, '0')}.json`));
    const data = await res.json();
    
    await new Promise(r => setTimeout(r, 200));
    
    ui.chapterNum.textContent = String(data.number).padStart(2, '0');
    ui.chapterTitle.textContent = data.title;
    ui.chapterText.innerHTML = format(data.content);
    
    ui.content.scrollTop = 0;
    ui.loading.style.display = 'none';
    ui.chapter.style.display = 'block';
    ui.chapter.style.animation = 'fadeIn 0.4s ease';
    
    updateUI();
  } catch (e) {
    ui.chapterText.innerHTML = '<p class="error">Error loading chapter</p>';
    ui.loading.style.display = 'none';
    ui.chapter.style.display = 'block';
  }
  
  loading = false;
}

function format(text) {
  return text
    .split('\n\n')
    .map(p => p.trim())
    .filter(Boolean)
    .map(p => {
      // Replace single newlines with <br>
      p = p.replace(/\n/g, '<br>');
      if (p.startsWith('—') || p.startsWith('«')) return `<p class="d">${p}</p>`;
      if (p.startsWith('[') && p.endsWith(']')) return `<p class="s">${p}</p>`;
      if (p.startsWith('*') && p.endsWith('*')) return `<p class="a">${p.replace(/\*/g, '')}</p>`;
      return `<p>${p}</p>`;
    })
    .join('');
}

function updateUI() {
  ui.headerTitle.textContent = `Chapter ${current}`;
  ui.prevBtn.disabled = current <= 1;
  ui.nextBtn.disabled = current >= total;
  
  document.querySelectorAll('.list-item').forEach(btn => {
    btn.classList.toggle('active', parseInt(btn.dataset.id) === current);
  });
  
  document.querySelectorAll('.dot').forEach((dot, i) => {
    dot.classList.toggle('active', i + 1 === current);
  });
}

function openSidebar() {
  ui.sidebar.classList.add('open');
  ui.overlay.classList.add('show');
  document.body.style.overflow = 'hidden';
  setTimeout(() => {
    const active = document.querySelector('.list-item.active');
    active?.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }, 200);
}

function closeSidebar() {
  ui.sidebar.classList.remove('open');
  ui.overlay.classList.remove('show');
  document.body.style.overflow = '';
}

ui.menuBtn?.addEventListener('click', openSidebar);
ui.closeBtn?.addEventListener('click', closeSidebar);
ui.overlay?.addEventListener('click', closeSidebar);
ui.prevBtn?.addEventListener('click', () => load(current - 1));
ui.nextBtn?.addEventListener('click', () => load(current + 1));

document.addEventListener('keydown', (e) => {
  if (e.key === 'ArrowLeft') load(current - 1);
  if (e.key === 'ArrowRight') load(current + 1);
  if (e.key === 'Escape') closeSidebar();
});

let touchX = 0;
ui.content?.addEventListener('touchstart', (e) => touchX = e.changedTouches[0].screenX, { passive: true });
ui.content?.addEventListener('touchend', (e) => {
  const diff = touchX - e.changedTouches[0].screenX;
  if (Math.abs(diff) > 60) diff > 0 ? load(current + 1) : load(current - 1);
}, { passive: true });

init();
</script>

<style>
  :root {
    --bg: #000000;
    --bg-elevated: #0c0c0c;
    --bg-hover: #1a1a1a;
    --text: #ffffff;
    --text-secondary: #8e8e93;
    --text-tertiary: #48484a;
    --border: rgba(255, 255, 255, 0.1);
  }

  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
  }

  button {
    background: transparent;
    border: none;
    font-family: inherit;
    font-size: inherit;
    color: inherit;
    -webkit-appearance: none;
    appearance: none;
  }

  .reader {
    min-height: 100vh;
    min-height: 100dvh;
    background: var(--bg);
    color: var(--text);
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', sans-serif;
    display: flex;
    flex-direction: column;
  }

  /* Header */
  .header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 100;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: saturate(180%) blur(20px);
    border-bottom: 1px solid var(--border);
  }

  .header-btn {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    border-radius: 8px;
    transition: all 0.2s ease;
  }

  .header-btn:hover {
    color: var(--text);
    background: var(--bg-hover);
  }

  .header-btn svg {
    width: 20px;
    height: 20px;
  }

  .header-title {
    font-size: 17px;
    font-weight: 600;
    letter-spacing: -0.01em;
  }

  /* Sidebar */
  .overlay {
    position: fixed;
    inset: 0;
    z-index: 150;
    background: rgba(0, 0, 0, 0);
    pointer-events: none;
    transition: background 0.3s ease;
  }

  .overlay.show {
    background: rgba(0, 0, 0, 0.7);
    pointer-events: auto;
  }

  .sidebar {
    position: fixed;
    top: 0;
    left: 0;
    bottom: 0;
    width: 300px;
    z-index: 200;
    background: #0c0c0c;
    border-right: 1px solid var(--border);
    transform: translateX(-100%);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    flex-direction: column;
  }

  .chapter-list {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    display: flex;
    flex-direction: column;
    padding: 0;
    background: transparent;
  }

  .sidebar.open {
    transform: translateX(0);
  }

  .sidebar-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px;
    border-bottom: 1px solid var(--border);
  }

  .sidebar-header h2 {
    font-size: 20px;
    font-weight: 700;
    letter-spacing: -0.02em;
  }

  .close-btn {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: none;
    color: var(--text-secondary);
    font-size: 24px;
    cursor: pointer;
    border-radius: 6px;
    transition: all 0.2s ease;
  }

  .close-btn:hover {
    color: var(--text);
    background: var(--bg-hover);
  }



  .list-item {
    display: flex;
    flex-direction: row;
    align-items: flex-start;
    gap: 12px;
    width: 100%;
    padding: 16px 20px;
    margin: 0;
    background: transparent !important;
    border: none;
    border-bottom: 1px solid var(--border);
    border-radius: 0;
    color: var(--text-secondary);
    text-align: left;
    cursor: pointer;
    transition: all 0.15s ease;
    flex-shrink: 0;
    -webkit-appearance: none;
    appearance: none;
    outline: none;
  }

  .list-item:last-child {
    border-bottom: none;
  }

  .list-item:hover {
    background: rgba(255, 255, 255, 0.05) !important;
    color: var(--text);
  }

  .list-item.active {
    color: var(--text);
    background: rgba(255, 255, 255, 0.08) !important;
  }

  .item-num {
    font-size: 15px;
    font-weight: 600;
    font-variant-numeric: tabular-nums;
    min-width: 28px;
    flex-shrink: 0;
  }

  .item-title {
    font-size: 15px;
    line-height: 1.4;
    flex: 1;
    word-break: break-word;
  }

  /* Content */
  .content {
    flex: 1;
    margin-top: 69px;
    margin-bottom: 80px;
    overflow-y: auto;
    overflow-x: hidden;
    -webkit-overflow-scrolling: touch;
  }

  .page {
    max-width: 680px;
    margin: 0 auto;
    padding: 32px 24px 48px;
  }

  .loading {
    display: flex;
    justify-content: center;
    padding: 60px 0;
  }

  .loading-line {
    width: 40px;
    height: 2px;
    background: var(--text-tertiary);
    animation: pulse 1.5s ease-in-out infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 0.3; }
    50% { opacity: 1; }
  }

  /* Chapter */
  .chapter {
    animation: fadeIn 0.4s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .chapter-header {
    margin-bottom: 40px;
  }

  .chapter-num {
    display: block;
    font-size: 14px;
    font-weight: 600;
    color: var(--text-secondary);
    letter-spacing: 0.1em;
    margin-bottom: 12px;
  }

  .chapter-title {
    font-size: 32px;
    font-weight: 700;
    line-height: 1.2;
    letter-spacing: -0.02em;
  }

  .chapter-text {
    font-size: 18px;
    line-height: 1.8;
    color: var(--text);
  }

  .chapter-text p {
    margin-bottom: 1.6em;
  }

  .chapter-text .d {
    margin-left: 16px;
  }

  .chapter-text .s {
    font-size: 15px;
    color: var(--text-secondary);
    font-style: italic;
    text-align: center;
    margin: 2em 0;
    padding: 1em 0;
    border-top: 1px solid var(--border);
    border-bottom: 1px solid var(--border);
  }

  .chapter-text .a {
    font-style: italic;
    color: var(--text-secondary);
    text-align: center;
  }

  .error {
    color: #ff3b30;
    text-align: center;
    padding: 40px;
  }

  /* Navigation */
  .nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 100;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 24px calc(16px + env(safe-area-inset-bottom));
    background: rgba(0, 0, 0, 0.9);
    backdrop-filter: saturate(180%) blur(20px);
    border-top: 1px solid var(--border);
  }

  .nav-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 10px 16px;
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-size: 15px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .nav-btn:hover:not(:disabled) {
    background: var(--bg-hover);
    border-color: var(--text-secondary);
  }

  .nav-btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }

  .nav-btn svg {
    width: 16px;
    height: 16px;
  }

  .nav-dots {
    display: flex;
    gap: 6px;
  }

  .dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--text-tertiary);
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .dot:hover {
    background: var(--text-secondary);
  }

  .dot.active {
    background: var(--text);
    transform: scale(1.2);
  }

  /* Scrollbar — Minimal Dark */
  .chapter-list::-webkit-scrollbar,
  .content::-webkit-scrollbar {
    width: 3px;
  }

  .chapter-list::-webkit-scrollbar-track,
  .content::-webkit-scrollbar-track {
    background: transparent;
  }

  .chapter-list::-webkit-scrollbar-thumb,
  .content::-webkit-scrollbar-thumb {
    background: var(--text-tertiary);
    border-radius: 2px;
  }

  .chapter-list::-webkit-scrollbar-thumb:hover,
  .content::-webkit-scrollbar-thumb:hover {
    background: var(--text-secondary);
  }

  /* Selection */
  ::selection {
    background: rgba(255, 255, 255, 0.2);
    color: var(--text);
  }

  /* Responsive */
  @media (max-width: 480px) {
    .page {
      padding: 24px 20px 40px;
    }
    .chapter-title {
      font-size: 28px;
    }
    .chapter-text {
      font-size: 17px;
    }
    .sidebar {
      width: 85%;
    }
  }
</style>
